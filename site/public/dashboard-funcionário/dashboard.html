<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/dash.css">
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
        integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Dashboard-Funcionário</title>
</head>

<body>
    <div class="container">
        <div class="navigation">
            <ul>
                <li>
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="home"></ion-icon>
                        </span>
                        <span class="title">Totem System</span>
                    </a>
                </li>
                <li>
                    <a href="./dashboard.html">
                        <span class="icon">
                            <ion-icon name="stats-chart"></ion-icon>
                        </span>
                        <span class="title">Gráficos</span>
                    </a>
                </li>
                <li>
                    <a href="historico.html">
                        <span class="icon">
                            <ion-icon name="archive"></ion-icon>
                        </span>
                        <span class="title">Histórico</span>
                    </a>
                </li>
                <li>
                    <a href="adicionartotem.html">
                        <span class="icon">
                            <ion-icon name="add-circle-outline"></ion-icon>
                        </span>
                        <span class="title">Adicionar Totem</span>
                    </a>
                </li>
                <li>
                    <a href="reporte.html">
                        <span class="icon">
                            <ion-icon name="megaphone-outline"></ion-icon>
                        </span>
                        <span class="title">Reporte Usuário</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="limparSessao()">
                        <span class="icon">
                            <ion-icon name="log-out"></ion-icon>
                        </span>
                        <span class="title">Sair</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- MAIN -->
        <div class="main">
            <div class="topbar">
                <div class="toggle">
                    <ion-icon name="menu-outline"></ion-icon>
                </div>
                <!-- USUARIO -->
                <div class="user">
                    <img src="../assets/imgs/download.png" alt="">
                </div>
            </div>
            <h1 id="titulo" class="ativo">Dados em Geral</h1>
            <!-- CARDS -->
            <div class="cardBox" id="cardBox1">
                <div class="card">
                    <div>
                        <div class="numbers">XX</div>
                        <div class="cardName">Totens alerta</div>
                    </div>
                    <div class="iconBox">
                        <ion-icon name="checkmark-circle-outline"></ion-icon>
                    </div>
                </div>
                <div class="card">
                    <div>
                        <div class="numbers">XX</div>
                        <div class="cardName">Totens Funcionando</div>
                    </div>
                    <div class="iconBox">
                        <ion-icon name="warning-outline"></ion-icon>
                    </div>
                </div>
                <div class="card">
                    <div>
                        <div class="numbers">XX</div>
                        <div class="cardName">Totens Desativados</div>
                    </div>
                    <div class="iconBox">
                        <ion-icon name="battery-dead-outline"></ion-icon>
                    </div>
                </div>
            </div>
            <div id="gerarCard"></div>
            <div class="cardBox" id="cardTotem1" style="display: none;">
                <div class="card">
                    <div>
                        <div class="numbers">Verde</div>
                        <div class="cardName">O totem está em suas perfeitas condições</div>
                    </div>
                    <div class="iconBox">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48"
                            viewBox="0 0 48 48">
                            <path fill="#4caf50"
                                d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"></path>
                            <path fill="#ccff90"
                                d="M34.602,14.602L21,28.199l-5.602-5.598l-2.797,2.797L21,33.801l16.398-16.402L34.602,14.602z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="card">
                    <div>
                        <div class="numbers">Amarelo</div>
                        <div class="cardName">Tome cuidado, algo de errado está por vir</div>
                    </div>
                    <div class="iconBox">
                        <img
                            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABmJLR0QA/wD/AP+gvaeTAAADiUlEQVRoge2ZTWhUVxTHf+clY147leCmo2JrCHUywXahDombgk33kWjrQtSVCE3FjXThQhTcCAG/0Iba5UClYk3rvnEhqE1GEaTMTBScFKkmG8UPOsH4jgsDxffu5H3mETC/3Zx77j3/w31z77n3whJLvN9IEoOoYlHOF1GrDygCeYQ1KNm5KC9RHqLUEG4hzijFibIITtzYsRLQcvcqlO9RZw/IJyG7/4NICeGcFCuPomqIlIBe+2IFba+OAvsAO2rwORrAeTL2Edlw52nYzqET0LHCNmAY+DhsXx+mgEHpqV4O0ylwAnqRFjoKJ4ADYZWFQ05TrxyUHbwO5B3ESa922GTtX4CBWNqCM8LLxk75qt7wc7T8HPQiLXxol0hPPMAAWftXvbql1c/RNwE6CicQvklEVjj6yT4a8nOa9xOa+8P+lpik8Cgq26W3MtLMoWkCWu5sx1lWAVZFibz5cNc7v28eq0UZBmCKmUy3fHn3iamx+Seky44RUXzC5Ob2HCPGBHRs/UqUvQunKTT79HbXalODeQbE2Q98sJCKQmLz2ho0NXgSUMVCdffCawqJo7tUvXq9M1DOF4FP09AUCmEtY10b3WZvAmp9nYqgSFh9HovBa1MKSqJhUfSavHQZbIsD1YLbZErAuFwtEjz7kimBj1IQEpXlboN/MbfIMSXwInUVwXnuNpgS+DcFIVHxHP5NB4Ya8HncSDGqz+aIVN0m0wzcSj5yQjiU3SZvAuL8mYqYSDijbovnQKOKxXjhAYutHlIm6al2um/zPDMggoNIKW686xNZ+oc66R/q5MZEAluLSMl0FWneB9Q6C/wXJ97xP3JMP8sw/SzD8Su5OEMBNGh1hk0NxgSk5+/HwM9xoyaH/CQba8blvflO7MwexrDuBuXQ1mly7bPk2mc5tPVx1GEApsi0NT0TB7lWueTnt4AoKtukt/J7M4d5a6G3F61yJnldAVFOzSceghRz9cpBlEuJiQrOFSarP/g5BbvcvfdZG09aL5De/ehlVszulHX3Z/wcA5XTsu7+DPXqt6CnAI0trzmKcpJ6dUcQ8RDlgeOv7gFEh4HYi7uLKVS+m+8e1EToA430VkbI2AXgDG+fh+LSADlNxi6EFQ9JPPI5DILuIWztpEwiUsLix9Qf+TxaFIvx/Ca0pQ+0iEUeZQ3/n69fIDzEYQJkHJxRemq3k3hmXWKJ9503x0/4rsA0qM0AAAAASUVORK5CYII=">
                    </div>
                </div>
                <div class="card">
                    <div>
                        <div class="numbers">Vermelho</div>
                        <div class="cardName">Verefique seu totem, ele está aparentando um erro critíco</div>
                    </div>
                    <div class="iconBox">
                        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="48" height="48"
                            viewBox="0 0 48 48">
                            <path fill="#f44336"
                                d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"></path>
                            <path fill="#fff" d="M29.656,15.516l2.828,2.828l-14.14,14.14l-2.828-2.828L29.656,15.516z">
                            </path>
                            <path fill="#fff" d="M32.484,29.656l-2.828,2.828l-14.14-14.14l2.828-2.828L32.484,29.656z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="graphBox" id="graficoBox" style="display: none;">
                <h1 class="legendaKPI">Disco</h1>
                <!-- <div class="kpi">
                    <h3>30% - 60%</h3>
                    <h3>60% - 90%</h3>
                    <h3>90%</h3>
                </div> -->
                <div class="box">
                    <canvas id="myChart"></canvas>
                </div>
                <h1 class="legendaKPI">Processos Totem</h1>
                <!-- <div class="kpi">
                    <h3>00% - 00%</h3>
                    <h3>00% - 00%</h3>
                    <h3>00% - 00%</h3>
                </div> -->
                <div class="box">
                    <canvas id="myChartBar"></canvas>
                </div>
            </div>

        </div>
    </div>
    </div>

    <script script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"> </script>
    <script script nomodule src="https://unpkg .com/ionicons@5.5.2/dist/ionicons/ionicons.js"> </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../graficos/chartbar.js"></script>
    <!-- GRÁFICO POLAR -->
    <script src="../graficos/chartpolar.js"></script>

    <script>

        var idEstacao = sessionStorage.FK_EMPRESA;

        window.onload = function buscarTotem() {

            fetch(`/medidas/totem/${idEstacao}`).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        criarCard(resposta)
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
        }

        function criarCard(resposta) {
            for (let index = 0; index < resposta.length; index++) {
                totem = resposta[index].idTotem
                gerarCard.innerHTML += `<div class="cardBox" id="cardBox2" onclick="obterDadosGrafico(${totem})"><div onclick="ativarTotem(${totem})" class="card"><div><div class="numbers">Totem ${totem}</div></div><div class="iconBox"><ion-icon name="build-outline"></ion-icon></div></div></div>`;
            }
        }

        // Menu Toggle
        let toggle = document.querySelector('.toggle');
        let navigation = document.querySelector('.navigation');
        let main = document.querySelector('.main');

        toggle.onclick = function () {
            navigation.classList.toggle('active');
            main.classList.toggle('active');
        }

        // adicionando o hover no menu selecionado
        let list = document.querySelectorAll(".navigation li");
        function activelink() {
            list.forEach((item) =>
                item.classList.remove('hovered'));
            this.classList.add('hovered');
        }
        list.forEach((item) =>
            item.addEventListener('mouseover', activelink));

        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

        function limparSessao() {
            // aguardar();
            sessionStorage.clear();
            // finalizarAguardar();
            window.location = "../login.html";
        }

        function ativarTotem() {
            var box1 = document.getElementById("cardBox1");
            var box2 = document.getElementById("cardBox2");
            var grafico = document.getElementById("graficoBox");
            var tituloGraficos = document.getElementById("titulo");
            var cardTotem = document.getElementById("cardTotem1");

            cardTotem.style.display = "grid";
            box1.style.display = "none";
            box2.style.display = "none";
            tituloGraficos.style.display = "none";
            grafico.style.display = "grid";
        }

        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

        let proximaAtualizacao;

        window.onload = obterDadosGrafico(1);

        verificar_autenticacao();

        function alterarTitulo(idTotem) {
            var tituloAquario = document.getElementById("tituloAquario")
            tituloAquario.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>Aquário " + idTotem + "</span>"
        }

        // O gráfico é construído com três funções:
        // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
        // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
        // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

        // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
        // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
        // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

        //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
        //     Para ajustar o "select", ajuste o comando sql em src/models
        function obterDadosGrafico(idTotem) {
            // alterarTitulo(idTotem)

            // if (proximaAtualizacao != undefined) {
            //     clearTimeout(proximaAtualizacao);
            // }

            fetch(`/medidas/ultimas/${idTotem}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        resposta.reverse();
                        console.log()
                        plotarGrafico(resposta, idTotem);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
        // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
        // A função *plotarGrafico* também invoca a função *atualizarGrafico*
        function plotarGrafico(resposta, idTotem) {
            
            console.log('iniciando plotagem do gráfico...');

            // Criando estrutura para plotar gráfico - labels
            let labels = [];

            // Criando estrutura para plotar gráfico - dados
            let dados = {
                labels: labels,
                datasets: [
                    {
                        yAxisID: 'y-Processador',
                        label: 'Processador em Uso',
                        borderColor: '#45b3e7',
                        backgroundColor: '#89cff0',
                        fill: false,
                        data: []
                    },
                    {
                        yAxisID: 'y-MemoriaUso',
                        label: 'Memória em Uso',
                        borderColor: '#ff3232',
                        backgroundColor: '#ff7f7f',
                        fill: false,
                        data: []
                    }
                ]
            };

            console.log('----------------------------------------------')
            console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
            console.log(resposta)

            // Inserindo valores recebidos em estrutura para plotar o gráfico
            for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                labels.push(registro.momento_grafico);
                dados.datasets[0].data.push(registro.processadorUso);
                dados.datasets[1].data.push(registro.memoriaUso);
            }

            console.log('----------------------------------------------')
            console.log('O gráfico será plotado com os respectivos valores:')
            console.log('Labels:')
            console.log(labels)
            console.log('Dados:')
            console.log(dados.datasets)
            console.log('----------------------------------------------')

            // Criando estrutura para plotar gráfico - config
            const config = {
                type: 'line',
                data: dados,
            };

            // Adicionando gráfico criado em div na tela
            let myChart = new Chart(
                document.getElementById('myChartBar'),
                config
            );

            setTimeout(() => atualizarGrafico(idTotem, dados, myChart), 2000);
        }
        
        function atualizarGrafico(idTotem, dados, myChart) {
            fetch(`/medidas/tempo-real/${idTotem}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (novoRegistro) {

                        console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(dados);

                        // document.getElementById("avisoCaptura").innerHTML = ""

                        // if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                        //     console.log("---------------------------------------------------------------")
                        //     console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        //     document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        //     console.log("Horário do novo dado capturado:")
                        //     console.log(novoRegistro[0].momento_grafico)
                        //     console.log("Horário do último dado capturado:")
                        //     console.log(dados.labels[dados.labels.length - 1])
                        //     console.log("---------------------------------------------------------------")
                        // } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].processadorUso); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[1].memoriaUso); // incluir uma nova medida de temperatura

                        myChart.update();
                        // }

                        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idTotem, dados, myChart), 2000);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idTotem, dados, myChart), 2000);
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });

        }
    </script>

</body>

</html>